<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Document</title>
    <link rel="stylesheet" type="text/css" href="./css/common.css" />
    <script src="./js/adapter.js"></script>
    <script src="./js/caller.js"></script>
</head>

<body>
    <div id="loading_state">loading...</div>
    <div id="open_call_state">
        <video id="remote_video"></video>
        <video id="local_video"></video>
    </div>
</body>
<script>
    var signaling_server;
    var servers;
    var peerConnection;

    function showVideoLayout() {
        document.querySelector("#loading_state").style.display = "none";
        document.querySelector("#open_call_state").style.display = "block";
    }

    function streamSuccess(stream) {
        showVideoLayout();
        var localVideo = document.querySelector("#local_video");
        localVideo.src = URL.createObjectURL(stream);
        localVideo.play();

        makePeerConnection(stream);
    }

    function streamError(error) {
        console.debug('streamError');
    }

    function setupMedia() {
        getUserMedia({
            audio: true,
            video: true
        }, streamSuccess, streamError);
    }

    function iceCandidate(ice_event) {
        if (ice_event.candidate) {
            console.log("caller ICE candidate");
            signaling_server.send(
                JSON.stringify({
                    type: "new_ice_candidate",
                    candidate: ice_event.candidate
                })
            );
        }
    }

    function handleError(error) {
        console.debug("error ", error);
    }

    function new_description_created(description) {
        console.log('new_description_created');
        peerConnection.setLocalDescription(
            description,
            function () {
                console.log('new_description_created send');
                signaling_server.send(
                    JSON.stringify({
                        token: 'room',
                        type: 'new_description',
                        sdp: description
                    })
                );
            },
            handleError
        );
    }

    // handle signals as a caller
    function caller_signal_handler(event) {
        var signal = JSON.parse(event.data);
        console.log('signal', signal);
        //if (signal.type === "callee_arrived") {
        if (signal.type === "join") {
            peerConnection.createOffer(
                new_description_created,
                handleError
            );
        } else if (signal.type === "new_ice_candidate") {
            peerConnection.addIceCandidate(
                new RTCIceCandidate(signal.candidate)
            );
        } else if (signal.type === "new_description") {
            console.log("caller signal handler : new_description");
            peerConnection.setRemoteDescription(
                new RTCSessionDescription(signal.sdp),
                function () {
                    console.log("peerConnection.remoteDescription.type == 'answer'");
                    if (peerConnection.remoteDescription.type == "answer") {
                        console.log('peerConnection.remoteDescription.type == "answer"');
                        // extend with your own custom answer handling here
                    }
                },
                handleError
            );
        } else {
            // extend with your own signal types here
        }
    }

    function makePeerConnection(stream) {
        /*var stun_server = "stun.l.google.com:19302";
        peerConnection = new RTCPeerConnection({"iceServers": [
            { "url": "stun:" + stun_server },
        ]});*/
        peerConnection = new RTCPeerConnection(servers);
        peerConnection.onicecandidate = iceCandidate;
        peerConnection.addStream(stream);

        // display remote video streams when they arrive using local <video> MediaElement
        peerConnection.onaddstream = function (event) {
            console.log('onaddStream');
            var remoteVideo = document.querySelector("#remote_video");
            remoteVideo.src = URL.createObjectURL(event.stream);
            remoteVideo.play();
            //connect_stream_to_src(event.stream, document.getElementById("remote_video"));

            document.getElementById("loading_state").style.display = "none";
            document.getElementById("open_call_state").style.display = "block";
        };

        signaling_server = new WebSocket('ws://localhost:3000');

        signaling_server.onopen = function () {
            console.log('signaling_server open');

            // setup caller signal handler
            signaling_server.onmessage = caller_signal_handler;

            // tell the signaling server you have joined the call 
            signaling_server.send(
                JSON.stringify({
                    type: 'join',
                    token: 'room'
                })
            );
        };
    }

    setupMedia();
</script>

</html>